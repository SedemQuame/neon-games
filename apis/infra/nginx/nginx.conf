worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
  worker_connections 4096;
}

http {
  # Security headers applied to all responses
  add_header X-Frame-Options "DENY" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header Content-Security-Policy "default-src 'self'" always;
  server_tokens off;

  # --- Upstream service definitions ---
  upstream auth_service {
    server auth-service:8001;
    keepalive 32;
  }

  upstream game_session_service {
    server game-session-service:8002;
    keepalive 64;
  }

  upstream payment_gateway {
    server payment-gateway:8003;
    keepalive 32;
  }

  upstream wallet_service {
    server wallet-service:8004;
    keepalive 32;
  }

  # trader-pool is internal only â€” no public NGINX upstream

  # --- Rate limiting zones ---
  limit_req_zone $binary_remote_addr zone=global_ip:10m rate=100r/m;
  limit_req_zone $http_authorization zone=per_token:20m rate=60r/m;

  server {
    listen 80;
    server_name _;

    # Rate limiting
    limit_req zone=global_ip burst=20 nodelay;
    limit_req zone=per_token burst=10 nodelay;

    # -- Auth Service --
    location /api/v1/auth/ {
      proxy_pass http://auth_service;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # -- Game Session Service (REST) --
    location /api/v1/games/ {
      proxy_pass http://game_session_service;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # -- WebSocket (game session) --
    location /ws {
      proxy_pass http://game_session_service;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "Upgrade";
      proxy_set_header Host $host;
      proxy_read_timeout 3600s;   # Keep WS connections alive for game duration
      proxy_send_timeout 3600s;
    }

    # -- Wallet Service --
    location /api/v1/wallet/ {
      proxy_pass http://wallet_service;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # -- Leaderboard --
    location /api/v1/leaderboard/ {
      proxy_pass http://wallet_service;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # -- Payment Gateway ---
    location /api/v1/payments/ {
      proxy_pass http://payment_gateway;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # -- Webhooks: NOT routed here. They go to a separate internal network. --
    # Webhook endpoints (/webhooks/*) should be on an internal-only service, not NGINX.

    # -- Health check passthrough --
    location /health {
      return 200 '{"status":"ok","gateway":"nginx"}';
      add_header Content-Type application/json;
    }
  }
}
