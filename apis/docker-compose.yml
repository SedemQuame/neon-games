version: "3.9"

# =============================================================================
# Glory Grid — Docker Compose (Simplified — No Kafka)
# Event bus: Redis PubSub | Inter-service: Direct HTTP
# =============================================================================

networks:
  gamehub_net:
    driver: bridge

volumes:
  mongo_data:
  redis_data:
  vault_data:

services:

  # ===========================================================================
  # INFRASTRUCTURE
  # ===========================================================================

  mongo:
    image: mongo:7
    container_name: gamehub_mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--keyFile", "/data/configdb/keyfile"]
    volumes:
      - mongo_data:/data/db
      - ./infra/mongo/init-replica.js:/docker-entrypoint-initdb.d/init-replica.js:ro
      - ./infra/mongo/replica.key:/data/configdb/keyfile
    ports:
      - "${MONGO_PORT:-27017}:27017"
    networks:
      - gamehub_net
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongo-init:
    image: mongo:7
    container_name: gamehub_mongo_init
    restart: "no"
    depends_on:
      mongo:
        condition: service_healthy
    command: >
      mongosh --host mongo
      -u ${MONGO_INITDB_ROOT_USERNAME}
      -p ${MONGO_INITDB_ROOT_PASSWORD}
      --authenticationDatabase admin
      --eval "try { rs.status() } catch(e) { rs.initiate({_id:'rs0', members:[{_id:0, host:'mongo:27017'}]}) }"
    networks:
      - gamehub_net

  redis:
    image: redis:7-alpine
    container_name: gamehub_redis
    restart: unless-stopped
    # Redis PubSub is the event bus between services
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - gamehub_net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  vault:
    image: hashicorp/vault:1.17
    container_name: gamehub_vault
    restart: unless-stopped
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_TOKEN}
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    cap_add:
      - IPC_LOCK
    volumes:
      - vault_data:/vault/data
    ports:
      - "8200:8200"
    networks:
      - gamehub_net
    healthcheck:
      test: ["CMD", "vault", "status", "-address=http://localhost:8200"]
      interval: 10s
      timeout: 5s
      retries: 5

  nginx:
    image: nginx:1.25-alpine
    container_name: gamehub_nginx
    restart: unless-stopped
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
    depends_on:
      auth-service:
        condition: service_started
      game-session-service:
        condition: service_started
      payment-gateway:
        condition: service_started
      wallet-service:
        condition: service_started
    networks:
      - gamehub_net

  # ===========================================================================
  # MICROSERVICES
  # ===========================================================================

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: gamehub_auth
    restart: unless-stopped
    env_file: .env
    environment:
      SERVICE_NAME: auth-service
      PORT: ${AUTH_SERVICE_PORT:-8001}
      JWT_PRIVATE_KEY_PATH: /run/secrets/jwt_private.pem
      JWT_PUBLIC_KEY_PATH: /run/secrets/jwt_public.pem
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${AUTH_SERVICE_PORT:-8001}:${AUTH_SERVICE_PORT:-8001}"
    volumes:
      - ./infra/dev-secrets/jwt_private.pem:/run/secrets/jwt_private.pem:ro
      - ./infra/dev-secrets/jwt_public.pem:/run/secrets/jwt_public.pem:ro
    networks:
      - gamehub_net

  game-session-service:
    build:
      context: ./game-session-service
      dockerfile: Dockerfile
    container_name: gamehub_game_session
    restart: unless-stopped
    env_file: .env
    environment:
      SERVICE_NAME: game-session-service
      PORT: ${GAME_SESSION_PORT:-8002}
      # Direct HTTP address of wallet service for balance reservation
      WALLET_SERVICE_URL: http://wallet-service:${WALLET_SERVICE_PORT:-8004}
      TRADER_POOL_URL: http://trader-pool:${TRADER_POOL_PORT:-8005}
      JWT_PUBLIC_KEY_PATH: /run/secrets/jwt_public.pem
      JWT_ISSUER: ${JWT_ISSUER:-gamehub-auth}
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      wallet-service:
        condition: service_started
    ports:
      - "${GAME_SESSION_PORT:-8002}:${GAME_SESSION_PORT:-8002}"
    volumes:
      - ./infra/dev-secrets/jwt_public.pem:/run/secrets/jwt_public.pem:ro
    networks:
      - gamehub_net

  payment-gateway:
    build:
      context: ./payment-gateway
      dockerfile: Dockerfile
    container_name: gamehub_payment
    restart: unless-stopped
    env_file: .env
    environment:
      SERVICE_NAME: payment-gateway
      PORT: ${PAYMENT_GATEWAY_PORT:-8003}
      WALLET_SERVICE_URL: http://wallet-service:${WALLET_SERVICE_PORT:-8004}
      JWT_PUBLIC_KEY_PATH: /run/secrets/jwt_public.pem
      JWT_ISSUER: ${JWT_ISSUER:-gamehub-auth}
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      vault:
        condition: service_healthy
    ports:
      - "${PAYMENT_GATEWAY_PORT:-8003}:${PAYMENT_GATEWAY_PORT:-8003}"
    volumes:
      - ./infra/dev-secrets/jwt_public.pem:/run/secrets/jwt_public.pem:ro
    networks:
      - gamehub_net

  wallet-service:
    build:
      context: ./wallet-service
      dockerfile: Dockerfile
    container_name: gamehub_wallet
    restart: unless-stopped
    env_file: .env
    environment:
      SERVICE_NAME: wallet-service
      PORT: ${WALLET_SERVICE_PORT:-8004}
      JWT_PUBLIC_KEY_PATH: /run/secrets/jwt_public.pem
      JWT_ISSUER: ${JWT_ISSUER:-gamehub-auth}
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${WALLET_SERVICE_PORT:-8004}:${WALLET_SERVICE_PORT:-8004}"
    volumes:
      - ./infra/dev-secrets/jwt_public.pem:/run/secrets/jwt_public.pem:ro
    networks:
      - gamehub_net

  trader-pool:
    build:
      context: ./trader-pool
      dockerfile: Dockerfile
    container_name: gamehub_trader
    restart: unless-stopped
    env_file: .env
    environment:
      SERVICE_NAME: trader-pool
      PORT: ${TRADER_POOL_PORT:-8005}
      WALLET_SERVICE_URL: http://wallet-service:${WALLET_SERVICE_PORT:-8004}
    depends_on:
      redis:
        condition: service_healthy
      vault:
        condition: service_healthy
    ports:
      - "${TRADER_POOL_PORT:-8005}:${TRADER_POOL_PORT:-8005}"
    networks:
      - gamehub_net
